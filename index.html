<!doctype html>
<html>
    <head>
        <title>Marvel</title>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
        <style>
            body {
                padding-top: 24px;
            }
            .hero-card {
                margin-top: 12px;
                padding: 6px;
                border: 1px solid #ababab;
            }
            .img-200 {
                height: 200px;
                width: 200px;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>Marvel Characters</h1>
            <div class="d-flex justify-content-between">
                <div>
                    <button type="button" id="prev" class="btn btn-dark">Prev</button>
                </div>
                <div>
                    <span id="resultCountBegin"></span>
                    <span> to </span>
                    <span id="resultCountEnd"></span>
                    <span> of total: </span>
                    <span id="totalAvailable"></span>
                </div>
                <div>
                    <button type="button" id="next" class="btn btn-dark">Next</button>
                </div>
            </div>
        </div>
        <div id="content" class="container"></div>
        <script>
            const state = {};

            let requestParams = {
                apikey: '622acfc296433d3d5fdbe221baa6da38',
                series: 354
            };

            const resultCountBeginElement = document.getElementById("resultCountBegin");
            const resultCountEndElement = document.getElementById("resultCountEnd");
            const totalAvailableElement = document.getElementById("totalAvailable");

            const nextBtn = document.getElementById("next");
            const prevBtn = document.getElementById("prev");

            nextBtn.addEventListener('click', (event) => {
                let offset = state.offset || 0;
                if (offset + state.count < state.total) {
                    requestParams.offset = offset + state.count;
                    makeRequest();
                }
            });

            prevBtn.addEventListener('click', (event) => {
                let offset = state.offset || 0;
                if (offset > 0) {
                    let newOffset = offset - state.count;
                    if (newOffset < 0) {
                        newOffset = 0;
                    }
                    requestParams.offset = offset;
                    makeRequest();
                }
            })
            let httpRequest;
            let requestUrl = 'https://gateway.marvel.com:443/v1/public/characters?';
            function makeRequest() {
                let queryParams = buildRequestParams(requestParams);
                httpRequest = new XMLHttpRequest();
                if (!httpRequest) {
                    alert('Giving up :( Cannot create an XMLHTTP instance');
                    return false;
                }
                httpRequest.onreadystatechange = readResponse;
                httpRequest.open('GET', requestUrl + queryParams);
                httpRequest.send();
            }

            function buildRequestParams(params) {
                let keys = Object.keys(params);
                let str = '' + keys[0] + '=' + params[keys[0]];
                for (let i = 1; i < keys.length; i++) {
                    str += "&" + keys[i] + '=' + params[keys[i]];
                }
                return str;
            }

            function readResponse() {
                if (httpRequest.readyState === XMLHttpRequest.DONE) {
                    if (httpRequest.status === 200) {
                        displayResponse(httpRequest.response);
                    } else {
                        alert('There was a problem with the request.');
                    }
                }
            }

            function displayResponse(response) {
                clearDisplay();
                let content = document.getElementById("content");
                let res = JSON.parse(response);
                console.log(res);
                setState(res.data);
                displayResultCount(res.data);
                let results = res.data.results;
                let heroesList = createElementOn(content, "div", "heroes");
                for (let hero of results) {
                    let heroText = '' + hero.id + ': ' + hero.name 
                    let heroElement = createElementOn(heroesList, "div", hero.id, heroText);
                    heroElement.classList.add("hero-card");
                    heroElement.innerHTML = `
                        <div class="media">
                            <img src="${hero.thumbnail.path + "." + hero.thumbnail.extension}" class="img-thumbnail img-200 align-self-center mr-3" alt=${hero.name}>
                            <div class="media-body">
                                <h5 class="mt-0">${hero.name}</h5>
                                <p>${hero.description}</p>
                            </div>
                        </div>`;
                }
            }

            function clearDisplay() {
                let content = document.getElementById("content");
                content.innerHTML = '';
                removeChildNodes(resultCountBeginElement);
                removeChildNodes(resultCountEndElement);
                removeChildNodes(totalAvailableElement);
            }

            function removeChildNodes(element) {
                for (let node of element.childNodes) {
                    element.removeChild(node);
                }
            }

            function setState(response_data) {
                state.limit = response_data.limit;
                state.offset = response_data.offset;
                state.count = response_data.count;
                state.total = response_data.total;
            }

            function displayResultCount(response_data) {
                addTextToElement(resultCountBeginElement, response_data.offset + 1);
                addTextToElement(resultCountEndElement, response_data.offset + response_data.count);
                addTextToElement(totalAvailableElement, response_data.total);
            }

            function createElementOn(target, tag, id, text) {
                let element = document.createElement(tag);
                if (text) {
                    let newContent = document.createTextNode(text);
                    element.appendChild(newContent);
                }
                if (id) {
                    element.id = id;
                }
                target.appendChild(element);
                return element;
            }

            function addTextToElement(target, text) {
                let textNode = document.createTextNode(text);
                target.appendChild(textNode);
            }

            makeRequest();
        </script>
    </body>
</html>